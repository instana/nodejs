#!/usr/bin/env bash

set -o pipefail

PACKAGES=(
  "debug@4"
  "chalk@5"
  # "debug"
  # "chalk"
  # "debug@4.4.2"
  # "chalk@5.6.1"
)

rm -rf app
mkdir -p app
cd app
npm init -y

# Always do a fresh install to get the latest allowed sub dependencies.
npm install @instana/collector --save
npm install @instana/serverless-collector --save
npm install @instana/aws-lambda --save
npm install @instana/aws-fargate --save
npm install @instana/google-cloud-run --save
npm install @instana/azure-container-services --save

echo "Checking for vulnerable packages..."

for pkg in "${PACKAGES[@]}"; do
  out="$(npm ls "$pkg" 2>&1 || true)"

  echo -e "\n"

  if printf "%s" "$out" | grep -q "(empty)"; then
    echo "✅ $pkg is not a dependency of Instana."
  else
    printf "❌ COMPROMISED $pkg"
    echo -e "\n"
    printf "%s" "$out"
  fi
done
