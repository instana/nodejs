FROM node:18.18.2-buster AS instana-aws-fargate-build-nodejs

ARG package_version
WORKDIR /instana
COPY package.json.npm ./
RUN sed -e s/SELF_VERSION/$package_version/g \
        -e s/INSTANA_AWS_FARGATE_VERSION/$package_version/g \
        package.json.npm > package.json
COPY .npmrc ./
COPY setup.sh ./
RUN npm install --only=production
RUN rm -f instana-*.tgz && \
 rm -f package.json && \
 rm -f package.json.npm && \
 rm -f .npmrc

# ---- Start over from scratch and copy npm modules
FROM scratch
COPY --from=instana-aws-fargate-build-nodejs /instana /instana

