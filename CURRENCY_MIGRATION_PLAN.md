# Currency Migration Plan - Test Structure Refactoring

## Goal
All currencies in currencies.json must use the new test structure:
- If a currency in currencies.json already has a versions array, skip it.
- Centralized `test_base.js` with test logic
- Version-specific `_vX/` folders with test runners
- Automatic folder generation via `create-version-test-folders.js`

---

## Template for each currency

### Step 1: Pick ONE currency without versions

### Step 1.1: Extract versions from `package.json`
- Search for the package name in the root `package.json` devDependencies/optionalDependencies
- Extract all versions (e.g. `"couchbase": "4.6.0"` → `4.6.0`)
- Note suffixed versions (e.g. `"couchbase-v4.4.3": "npm:couchbase@4.4.3"` → `4.4.3`)

### Step 2: Update `currencies.json`
```json
{
  "name": "PACKAGE_NAME",
  "versions": [
    { "v": "VERSION1" },
    { "v": "VERSION2" },
    { "v": "VERSION3", "optional": true }
  ]
}
```

**Notes:**
- `v`: Version number (required)
- `optional`: Boolean flag (optional, default: false) - marks optionalDependencies

### Step 3: Clean up root `package.json`
- Remove all package variants from devDependencies/optionalDependencies
- Do NOT remove the original package (e.g. keep `"couchbase": "4.6.0"`)

### Step 4: Adjust test structure

#### 4a. Prepare

Review the mssql test structure first!
Then search for the test folder of the current currency. If the test folder is too complex, skip and pick another currency. Complex test structures require manual refactoring.

You always find the test folder by searching for `require(currency)` in the test directory!

#### 4b. Create `test_base.js`
- Extract test logic from `test.js`
- Wrap in a function: `module.exports = function (version) { ... }`
- Path adjustment: `path.join(__dirname, '_v${semver.major(version)}', 'app.js')`

#### 4c. Replace old `test.js`
- Delete it (it will be auto-generated by `create-version-test-folders.js`)

#### 4d. Adjust app files if needed
- `app.js`, `app.mjs` must remain in the root folder
- They will be symlinked into `_vX/` (no manual action needed!)

### Step 5: Run `create-version-test-folders.js`
```bash
node bin/create-version-test-folders.js
```
Automatically generates:
- `_v1/`, `_v2/`, `_v3/`, etc. for each major version
- `_vX/test.js` with `testBase.call(this, 'FULL_VERSION')`
- `_vX/package.json` with the specific version
- Symlinks for shared files

### Step 6: Verification
- [ ] `currencies.json` has a `versions` array
- [ ] Root `package.json` has package variants removed
- [ ] `_vX/` folders exist
- [ ] `test_base.js` exists
- [ ] Symlinks work

