apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: collector-14-redis
spec:
  sidecars:
    - name: redis
      image: public.ecr.aws/docker/library/redis:7.4.3
      imagePullPolicy: IfNotPresent
    - name: redis-slave
      image: public.ecr.aws/docker/library/redis:7.4.3
      imagePullPolicy: IfNotPresent
      args:
          - "redis-server"
          - "--replicaof"
          - "127.0.0.1"
          - "6379"
          - "--port"
          - "6380"
    - name: redis-sentinel
      image: public.ecr.aws/docker/library/redis:7.4.3
      imagePullPolicy: IfNotPresent
      args:
          - "sh"
          - "-c"
          - |
            echo "sentinel monitor mymaster 127.0.0.1 6379 2" > /etc/sentinel.conf
            echo "sentinel down-after-milliseconds mymaster 1000" >> /etc/sentinel.conf
            echo "sentinel failover-timeout mymaster 5000" >> /etc/sentinel.conf
            echo "sentinel parallel-syncs mymaster 1" >> /etc/sentinel.conf
            echo "sentinel resolve-hostnames no" >> /etc/sentinel.conf
            redis-server /etc/sentinel.conf --sentinel --port 26379
  envFrom:
    - configMapRef:
        name: environment-properties
  params:
    - name: node-version
      value: $(params.node-version)
    - name: npm-version
      value: $(params.npm-version)
    - name: repository
      value: $(params.repository)
    - name: revision
      value: $(params.revision)
    - name: continuous-delivery-context-secret
      value: $(params.continuous-delivery-context-secret)
    - name: esm
      value: $(params.esm)
    - name: coverage
      value: $(params.coverage)
    - name: prerelease
      value: $(params.prerelease)
  workspaces:
    - name: output
      mountPath: /artifacts
  steps:
    - name: run-test-group
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "AWS_ACCESS_KEY_ID"
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "AWS_SECRET_ACCESS_KEY"
        - name: AZURE_REDIS_CLUSTER_PWD
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "AZURE_REDIS_CLUSTER_PWD"
        - name: DB2_CONNECTION_STR
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "DB2_CONNECTION_STR"
        - name: GOOGLE_APPLICATION_CREDENTIALS_CONTENT
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "GOOGLE_APPLICATION_CREDENTIALS_CONTENT"
        - name: AZURE_SQL_PWD
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "AZURE_SQL_PWD"
        - name: AZURE_STORAGE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "AZURE_STORAGE_ACCOUNT_KEY"
      image: public.ecr.aws/docker/library/node:$(params.node-version)
      imagePullPolicy: IfNotPresent
      script: |
        #!/bin/bash
        AVAILABLE_SIDECARS="redis,redis-slave,redis-sentinel"
        SIDECAR_COUNTS="redis=25,redis-slave=25,redis-sentinel=25,zookeeper=3,kafka=3,kafka-topics=3,schema-registry=3,postgres=2,elasticsearch=2,mongodb=1,couchbase=1,rabbitmq=1,nats=1,nats-streaming=1,nats-streaming-2=1,mysql=1,localstack=1,memcached=1,oracledb=1"
        ARTIFACTS_PATH="$(workspaces.output.path)"
        cd $ARTIFACTS_PATH
        BASE_REVISION=$(git rev-parse origin/main)
        CIRCLE_COMPARE_URL=""
        # MODIFIED_FILES=""
        GIT_COMMIT_DESC=""
        if [ "$(params.prerelease)" == "true" ]; then
          source bin/install-prerelease.sh
          echo "Using node: $(node --version)"
        fi
        if [ -n "$(params.npm-version)" ]; then
          npm install npm@$(params.npm-version) -g
        fi
        npm config set registry http://registry.npmjs.org
        if [ -n "$(params.revision)" ]; then
          CIRCLE_COMPARE_URL="$(params.repository)/compare/$BASE_REVISION..$(params.revision)"
          # MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r $(echo ${CIRCLE_COMPARE_URL} | cut -d/ -f 7))
          GIT_COMMIT_DESC=$(git log --format=%B -n 1 $(params.revision))
        fi
        echo "BASE_REVISION: $BASE_REVISION"
        echo "CIRCLE_COMPARE_URL: $CIRCLE_COMPARE_URL"
        # echo "MODIFIED_FILES: $MODIFIED_FILES"
        echo "GIT_COMMIT_DESC: $GIT_COMMIT_DESC"
        if echo "$GIT_COMMIT_DESC" | grep -q '\[ci reduced\]' && true; then
          echo "Skipping group."
          touch "collector-14-redis.succeeded"
          exit 0
        fi
        export CI=true
        export GCP_PROJECT="k8s-brewery"
        export AZURE_SQL_USERNAME="admin@instana@nodejs-team-db-server"
        export AZURE_SQL_SERVER="nodejs-team-db-server.database.windows.net"
        export AZURE_REDIS_CLUSTER="team-nodejs-redis-cluster-tekton.redis.cache.windows.net:6380"
        export AZURE_SQL_DATABASE="azure-nodejs-test"
        export AZURE_STORAGE_ACCOUNT_NAME="nodejstracerteam"
        if [ "$(params.esm)" == "true" ]; then
          export RUN_ESM=true
          if ! echo "test:ci:collector" | grep -q 'ci:collector'; then
            echo "Skipping tests because group does not support ESM."
            touch "collector-14-redis.succeeded"
            exit 0
          fi
        fi
        if [ "true" == "true" ]; then
          CLAIMED_TESTS=$(bash ./packages/collector/scripts/claim-tests.sh "$AVAILABLE_SIDECARS" "test/**/*.test.js" "40" "$ARTIFACTS_PATH" "$SIDECAR_COUNTS")
          if [ -z "$CLAIMED_TESTS" ]; then
            echo "No tests to claim for this task"
            touch "collector-14-redis.succeeded"
            exit 0
          fi
          echo "Claimed tests: $CLAIMED_TESTS"
          # Write mapping to shared file (printed by tasks-results)
          SHORT_NAMES=$(echo "$CLAIMED_TESTS" | tr ' ' '\n' | sed 's|.*/currencies/||; s|.*/misc/||; s|.*/unit/||; s|/test\.js$||' | tr '\n' ', ' | sed 's/,$//')
          echo "collector-14-redis: $SHORT_NAMES" >> "$ARTIFACTS_PATH/test-mapping.txt"
        fi
        rm -f "collector-14-redis.succeeded" "collector-14-redis.failed"
        retry=1
        LAST_EXIT=1
        while [ $retry -le 2 ]; do
          LAST_EXIT=0
          if [ "$(params.coverage)" == "true" ]; then
            if [ "true" == "true" ]; then
              TEST_FILES="$CLAIMED_TESTS" CI_TEST_SPLIT="40" CI_TEST_SPLIT_CURRENT="14" npm run coverage-ci --npm_command="test:ci:collector" --report_dir="collector-14-redis" || LAST_EXIT=$?
            else
              CI_TEST_SPLIT="40" CI_TEST_SPLIT_CURRENT="14" npm run coverage-ci --npm_command="test:ci:collector" --report_dir="collector-14-redis" || LAST_EXIT=$?
            fi
          else
            if [ "true" == "true" ]; then
              TEST_FILES="$CLAIMED_TESTS" CI_TEST_SPLIT="40" CI_TEST_SPLIT_CURRENT="14" npm run "test:ci:collector" || LAST_EXIT=$?
            else
              CI_TEST_SPLIT="40" CI_TEST_SPLIT_CURRENT="14" npm run "test:ci:collector" || LAST_EXIT=$?
            fi
          fi
          if [ $LAST_EXIT -eq 0 ]; then
            touch "collector-14-redis.succeeded"
            break
          else
            echo "Attempt $retry failed with exit code $LAST_EXIT"
            retry=$((retry + 1))
          fi
        done
        if [ ! -f "collector-14-redis.succeeded" ]; then
          echo "All $((retry - 1)) retries failed for collector-14-redis"
          touch "collector-14-redis.failed"
          exit 1
        fi