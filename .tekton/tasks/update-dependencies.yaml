apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-dependencies
spec:
  params:
    - name: continuous-delivery-context-secret
      default: secure-properties
    - name: type
      value: $(params.type)
    - name: node-version
      value: $(params.node-version)
  workspaces:
    - name: output
      mountPath: /artifacts
  steps:
    - name: execute       
      image: node:$(params.node-version)
      script: |
        #!/bin/bash

        ARTIFACTS_PATH="$(workspaces.output.path)"
        cd $ARTIFACTS_PATH

        if git show-ref -q --heads currency-bot; then
          echo 'Branch exists. Skipping currency bot.'
          return
        fi

        git fetch --all
        git pull --all
        
        echo "Running patch and minor updates..."
        MAJOR_UPDATES_MODE=false BRANCH=currency-bot node bin/currency/update-currencies.js

        echo "Running major updates..."
        MAJOR_UPDATES_MODE=true BRANCH=currency-bot-major node bin/currency/update-currencies.js
        
