apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: tasks-results
spec:
  workspaces:
    - name: output
      mountPath: /artifacts
  params:
    - name: properties-file
      default: build.properties
    - name: node-version
      value: $(params.node-version)
    - name: continuous-delivery-context-secret
      value: $(params.continuous-delivery-context-secret)
    - name: coverage
      value: $(params.coverage)
    - name: pr-number
      default: ""
    - name: pr-branch
      default: ""
    - name: target-branch
      default: "main"
    - name: pr-payload
      default: ""
  steps:
    - name: print-all-results
      image: public.ecr.aws/docker/library/node:$(params.node-version)
      imagePullPolicy: IfNotPresent
      env:
        - name: PROPERTIES_FILE
          value: $(params.properties-file)
        - name: SONAR_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "SONAR_TOKEN"
      script: |
        #!/bin/bash

        ARTIFACTS_PATH="$(workspaces.output.path)"
        cd $ARTIFACTS_PATH

        echo ""
        echo "=== Test Distribution ==="
        if [ -f "$ARTIFACTS_PATH/test-mapping.txt" ]; then
          sort "$ARTIFACTS_PATH/test-mapping.txt"
        else
          echo "(no test mapping found)"
        fi
        echo ""

        # Not generic yet. We only support claimed tests for the collector package.
        echo "=== Post-flight: Verify claimed tests ==="
        VERIFY_EXIT=0
        bash ./packages/collector/scripts/verify-all-claimed.sh "$ARTIFACTS_PATH" || VERIFY_EXIT=$?
        echo ""

        if [ $VERIFY_EXIT -ne 0 ] || find "$ARTIFACTS_PATH" -maxdepth 1 -type f -name '*.failed' | grep -q .; then
          echo "PIPELINE_RESULT=Failed"
          echo "PIPELINE_RESULT=Failed" >> $ARTIFACTS_PATH/$PROPERTIES_FILE
        else
          echo "PIPELINE_RESULT=Succeeded"
          echo "PIPELINE_RESULT=Succeeded" >> $ARTIFACTS_PATH/$PROPERTIES_FILE
        fi

        if [ "$(params.coverage)" == "true" ]; then
          echo "Running ESLint..."
          npx eslint packages/ -f json -o eslint-report.json || true

          echo "Installing SonarCloud scanner..."
          # 4.3.3 is broken and does not ship a global binary!
          npm install -g @sonar/scan@4.3.2

          if [ -n "$(params.pr-number)" ]; then
            echo '$(params.pr-payload)' > pr.json

            # Extract draft flag
            if command -v jq >/dev/null 2>&1; then
              PR_IS_DRAFT=$(jq -r '.draft // "false"' pr.json)
            else
              PR_IS_DRAFT=$(grep -o '"draft":[^,}]*' pr.json | cut -d':' -f2 | tr -d '[:space:]')
              [ -z "$PR_IS_DRAFT" ] && PR_IS_DRAFT="false"
            fi
            echo "PR draft status: $PR_IS_DRAFT"

            if [ "$PR_IS_DRAFT" = "false" ]; then
              echo "Running Sonar scan for PR #$(params.pr-number)"
              sonar -Dsonar.token="$SONAR_TOKEN" \
                    -Dsonar.pullrequest.key="$(params.pr-number)" \
                    -Dsonar.pullrequest.branch="$(params.pr-branch)" \
                    -Dsonar.pullrequest.base="$(params.target-branch)" \
                    -Dsonar.newCode.referenceBranch=$(params.target-branch)
            else
              echo "PR is draft â€” skipping Sonar scan."
            fi
          else
            echo "Running main branch analysis..."
            sonar -Dsonar.token=$SONAR_TOKEN
          fi
        fi

    - name: save-global-cache
      image: public.ecr.aws/docker/library/node:$(params.node-version)
      imagePullPolicy: IfNotPresent
      env:
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.continuous-delivery-context-secret)
              key: "apikey"
              optional: true
      script: |
        #!/bin/bash
        ARTIFACTS_PATH="$(workspaces.output.path)"
        cd $ARTIFACTS_PATH

        # Current Date Key
        TODAY=$(date +%F)
        CACHE_KEY="npm-cache-apps-$TODAY"
        echo "Checking if we need to save cache: $CACHE_KEY"

        if [ ! -d ".npm-offline-cache" ]; then
          echo ".npm-offline-cache directory not found in workspace. Skipping save."
          exit 0
        fi

        # Install IBM Cloud CLI
        echo "Installing IBM Cloud CLI..."
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh > /dev/null
        ibmcloud plugin install cloud-object-storage -f -r 'IBM Cloud' > /dev/null
        ibmcloud login -a https://cloud.ibm.com -r eu-de --apikey $API_KEY

        # Check if cache exists
        if ibmcloud cos head-object --bucket npm-cache --key "$CACHE_KEY.tar.zst" > /dev/null 2>&1; then
          echo "Cache for today already exists. Skipping upload."
          exit 0
        fi

        echo "Cache for today missing. Uploading..."
        apt-get update -y > /dev/null && apt-get install -y zstd > /dev/null
        
        tar -cf - .npm-offline-cache | zstd -o "$CACHE_KEY.tar.zst"
        ibmcloud cos upload --bucket npm-cache --key "$CACHE_KEY.tar.zst" --file "$CACHE_KEY.tar.zst"
        echo "Cache uploaded."



